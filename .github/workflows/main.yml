name: ğŸª„ XServerè‡ªåŠ¨ç­¾åˆ°

on:
  repository_dispatch:
    types: [XServer]          # Webhook è§¦å‘å…³é”®è¯ï¼šXServer
  workflow_dispatch:        # ä¿ç•™æ‰‹åŠ¨ç‚¹å‡»è§¦å‘æŒ‰é’®

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          python -m playwright install chromium

      - name: è®¾ç½®ä»£ç†éš§é“ (Gost)
        env:
          PROXY_STR: ${{ secrets.PROXY_SERVER }}
        run: |
          wget -q https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz
          gunzip gost-linux-amd64-2.11.5.gz
          chmod +x gost-linux-amd64-2.11.5
          nohup ./gost-linux-amd64-2.11.5 -L :1080 -F "$PROXY_STR" > gost.log 2>&1 &
          sleep 5
          cat gost.log || true

      - name: ğŸ² å®šæ—¶ä»»åŠ¡åŸºç¡€ä¸Šéšæœºå»¶è¿Ÿï¼ˆ0-119ç§’ï¼‰
        run: |
          delay=$((RANDOM % 120))
          echo "Random delay: ${delay}s"
          sleep $delay

      - name: è¿è¡Œè„šæœ¬
        env:
          XSERVER_EMAIL: ${{ secrets.XSERVER_EMAIL }}
          XSERVER_PASSWORD: ${{ secrets.XSERVER_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PROXY_SERVER: socks5://127.0.0.1:1080
        run: python renew.py

      # â±ï¸ æäº¤ time.txt åˆ°ä»“åº“(ç”¨äºè§£å†³60å¤©æ— æ–‡ä»¶å˜åŒ–çš„é™åˆ¶)
      - name: Commit time.txt to repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ ! -f time.txt ]; then
            echo "é¦–æ¬¡ç”Ÿæˆæ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          else
            echo "$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          fi

          git add time.txt

          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "â±ï¸ æ›´æ–°æ—¶é—´æ–‡ä»¶: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin HEAD:main
          fi
